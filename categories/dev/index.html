
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Lional Personal Blog">
    <title>分类: dev - Lional Personal Blog</title>
    <meta name="author" content="Lional">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="Game programming, Cocos2D-X, Unity3D, C++, Object-C, Golang, Lua, Javascript">
<meta property="og:type" content="blog">
<meta property="og:title" content="Lional Personal Blog">
<meta property="og:url" content="https://ibunnyteam.github.io/categories/dev/index.html">
<meta property="og:site_name" content="Lional Personal Blog">
<meta property="og:description" content="Game programming, Cocos2D-X, Unity3D, C++, Object-C, Golang, Lua, Javascript">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lional Personal Blog">
<meta name="twitter:description" content="Game programming, Cocos2D-X, Unity3D, C++, Object-C, Golang, Lua, Javascript">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-hbbiygd4997sa74ypphgq4imalnn9qdlfdggvz93pinykgel3qklv9ici3bp.min.css">
    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ "
            aria-label=""
        >
            Lional Personal Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/resume"
                            
                            rel="noopener"
                            title="个人简历"
                        >
                        <i class="sidebar-button-icon fa fa-book" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">个人简历</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜索"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/3dseals"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2018/05/24/用容器配置mysql主从实现读写分离/"
                            aria-label=": 用容器配置mysql主从实现读写分离"
                        >
                            用容器配置mysql主从实现读写分离
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-05-24T15:22:23+08:00">
	
		    5月 24, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/dev/">dev</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="容器简介"><a href="#容器简介" class="headerlink" title="容器简介"></a>容器简介</h2><p>Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的Linux机器上，也可以实现虚拟化，容器是完全使用沙箱机制，相互之间不会有任何接口。</p>
<h2 id="CentOS-7-安装docker"><a href="#CentOS-7-安装docker" class="headerlink" title="CentOS 7 安装docker"></a>CentOS 7 安装docker</h2><p>安装必要的一些系统工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum update</span></span><br></pre></td></tr></table></figure>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y yum-utils device-mapper-persistent-<span class="class"><span class="keyword">data</span> lvm2</span></span><br></pre></td></tr></table></figure>
<p>添加软件源信息</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum-config-manager --<span class="built_in">add</span>-repo http://mirrors.aliyun.<span class="keyword">com</span>/docker-<span class="keyword">ce</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br></pre></td></tr></table></figure>
<p>更新并安装 Docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum makecache fast</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum -y install docker-ce</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> 开启容器服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start docker</span></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> 官方软件源默认启用了最新的软件，您可以通过编辑软件源的方式获取各个版本的软件包。例如官方并没有将测试版本的软件源置为可用，你可以通过以下方式开启。同理可以开启各种测试版本等。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/yum.repos.d/docker-ce.repo</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   将 [docker-ce-test] 下方的 enabled=0 修改为 enabled=1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum list docker-ce.x86_64 --showduplicates | sort -r</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   Loading mirror speeds from cached hostfile</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   Loaded plugins: branch, fastestmirror, langpacks</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable</span></span><br><span class="line"><span class="meta">$</span><span class="bash">   Available Packages</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> Step2 : 安装指定版本的Docker-CE: (VERSION 例如上面的 17.03.0.ce.1-1.el7.centos)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum -y install docker-ce-[VERSION]</span></span><br></pre></td></tr></table></figure>
<p>注册一个阿里的账号,<br>进入加速器页面<a href="https://cr.console.aliyun.com/#/accelerator" target="_blank" rel="noopener">https://cr.console.aliyun.com/#/accelerator</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/docker/daemon.json</span></span><br></pre></td></tr></table></figure>
<p>内容如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"registry-mirrors"</span>: [<span class="string">"https://你的阿里云加速地址.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl daemon-reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart docker</span></span><br></pre></td></tr></table></figure>
<h3 id="常用docker命令"><a href="#常用docker命令" class="headerlink" title="常用docker命令"></a>常用docker命令</h3><p>查看运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps</span></span><br></pre></td></tr></table></figure>
<p>查看所有容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps -a</span></span><br></pre></td></tr></table></figure>
<p>进入容器<br>其中字符串为容器ID:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it d27bd3008ad9 /bin/bash</span></span><br></pre></td></tr></table></figure>
<p>1.停用全部运行中的容器:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>docker stop <span class="variable">$(</span>docker ps -q)</span><br></pre></td></tr></table></figure>
<p>2.删除全部容器：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>docker rm <span class="variable">$(</span>docker ps -aq)</span><br></pre></td></tr></table></figure>
<p>3.一条命令实现停用并删除容器：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>docker stop <span class="variable">$(</span>docker ps -q) &amp;&amp; docker rm <span class="variable">$(</span>docker ps -aq)</span><br></pre></td></tr></table></figure>
<h2 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h2><p>centOS上比yum安装mysql要方便.</p>
<p>###安装mysql-client，用于访问mysql容器数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum -y install mariadb</span></span><br></pre></td></tr></table></figure>
<h3 id="单独MySQL模式"><a href="#单独MySQL模式" class="headerlink" title="单独MySQL模式"></a>单独MySQL模式</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">e TIMEZONE=Asia/Shanghai \</span></span><br><span class="line"><span class="ruby">-v /data/mariadb-<span class="symbol">master:</span>/data/mariadb \</span></span><br><span class="line"><span class="ruby">-e MYSQL_ROOT_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-e REPLICATION_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-p <span class="number">3306</span><span class="symbol">:</span><span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">mariadb</span></span><br></pre></td></tr></table></figure>
<h3 id="MariaDB-MASTER"><a href="#MariaDB-MASTER" class="headerlink" title="MariaDB MASTER"></a>MariaDB MASTER</h3><p>进入容器需要修改镜像<br>将下面内容添加进/etc/mysql/conf.d/*.cnf<br>从机server-id=2</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span>=MIXED</span><br><span class="line"><span class="attr">default-time_zone</span> = <span class="string">'+8:00'</span></span><br></pre></td></tr></table></figure>
<p>提交</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">commit</span> -m <span class="string">"set log bin on"</span> -a <span class="string">"lional"</span> d27bd3008ad9 mariadb-<span class="keyword">master</span>:<span class="number">1.0</span></span><br><span class="line">docker <span class="keyword">commit</span> -m <span class="string">"set log bin on"</span> -a <span class="string">"lional"</span> d27bd3008ad9 mariadb-<span class="keyword">slave</span>:<span class="number">1.0</span></span><br></pre></td></tr></table></figure>
<p>运行master, 这里LOG_BIN参数没有用,所以在上面修改了镜像</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name mysql-master \</span></span><br><span class="line"><span class="ruby">-e TIMEZONE=Asia/Shanghai \</span></span><br><span class="line"><span class="ruby">-v /data/mariadb-<span class="symbol">master:</span>/data/mariadb \</span></span><br><span class="line"><span class="ruby">-e MYSQL_ROOT_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-e LOG_BIN=mysql-bin \</span></span><br><span class="line"><span class="ruby">-e BINLOG_FORMAT=MIXED \</span></span><br><span class="line"><span class="ruby">-e REPLICATION_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-p <span class="number">3306</span><span class="symbol">:</span><span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">mariadb-<span class="symbol">master:</span><span class="number">1.0</span></span></span><br></pre></td></tr></table></figure>
<p>查询容器的ip地址</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>docker inspect --format=<span class="string">'&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;'</span> <span class="variable">$(</span>docker ps -a -q)</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172<span class="selector-class">.17</span><span class="selector-class">.0</span><span class="selector-class">.2</span></span><br></pre></td></tr></table></figure>
<p>链接容器mysql</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span> <span class="selector-tag">-uroot</span> <span class="selector-tag">-padmin</span> <span class="selector-tag">-h</span> 172<span class="selector-class">.17</span><span class="selector-class">.0</span><span class="selector-class">.2</span></span><br></pre></td></tr></table></figure>
<p>查看master是否启用了log_bin</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show variables like '%log_bin%';</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">|<span class="string"> Variable_name                   </span>|<span class="string"> Value                          </span>|</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">|<span class="string"> log_bin                         </span>|<span class="string"> ON                             </span>|</span><br><span class="line">|<span class="string"> log_bin_basename                </span>|<span class="string"> /var/lib/mysql/mysql-bin       </span>|</span><br><span class="line">|<span class="string"> log_bin_compress                </span>|<span class="string"> OFF                            </span>|</span><br><span class="line">|<span class="string"> log_bin_compress_min_len        </span>|<span class="string"> 256                            </span>|</span><br><span class="line">|<span class="string"> log_bin_index                   </span>|<span class="string"> /var/lib/mysql/mysql-bin.index </span>|</span><br><span class="line">|<span class="string"> log_bin_trust_function_creators </span>|<span class="string"> OFF                            </span>|</span><br><span class="line">|<span class="string"> sql_log_bin                     </span>|<span class="string"> ON                             </span>|</span><br><span class="line">+---------------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>
<p>查看主机状态,注意启动从机的时候bin和pos的参数</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show master status;</span><br><span class="line"><span class="code">+------------------+</span>----------<span class="code">+--------------+</span>------------------+</span><br><span class="line">| File             | Position | Binlog<span class="emphasis">_Do_</span>DB | Binlog<span class="emphasis">_Ignore_</span>DB |</span><br><span class="line"><span class="code">+------------------+</span>----------<span class="code">+--------------+</span>------------------+</span><br><span class="line">| mysql-bin.000003 |      342 |              |                  |</span><br><span class="line"><span class="code">+------------------+</span>----------<span class="code">+--------------+</span>------------------+</span><br></pre></td></tr></table></figure>
<p>添加slave账户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">to</span> <span class="string">'slave'</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'reader'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure>
<h3 id="MariaDB-SLAVE"><a href="#MariaDB-SLAVE" class="headerlink" title="MariaDB SLAVE"></a>MariaDB SLAVE</h3><h4 id="没有sql导入的情况"><a href="#没有sql导入的情况" class="headerlink" title="没有sql导入的情况"></a>没有sql导入的情况</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name mysql-slave2 \</span></span><br><span class="line"><span class="ruby">-e TIMEZONE=Asia/Shanghai \</span></span><br><span class="line"><span class="ruby">-v /data/mariadb-<span class="symbol">slave:</span>/data/mariadb \</span></span><br><span class="line"><span class="ruby">-e MYSQL_ROOT_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-e LOG_BIN=mysql-bin \</span></span><br><span class="line"><span class="ruby">-e BINLOG_FORMAT=MIXED \</span></span><br><span class="line"><span class="ruby">-e REPLICATION_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-e MASTER_LOG_FILE=mysql-bin.<span class="number">000003</span> \</span></span><br><span class="line"><span class="ruby">-e MASTER_LOG_POS=<span class="number">342</span> \</span></span><br><span class="line"><span class="ruby">-e MASTER_PORT=<span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">-e MASTER_HOST=<span class="number">172.17</span>.<span class="number">0</span>.<span class="number">2</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">3310</span><span class="symbol">:</span><span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">mariadb-<span class="symbol">slave2:</span><span class="number">1.0</span></span></span><br></pre></td></tr></table></figure>
<h4 id="先用sql文件导入再同步"><a href="#先用sql文件导入再同步" class="headerlink" title="先用sql文件导入再同步"></a>先用sql文件导入再同步</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-<span class="ruby">-restart=always \</span></span><br><span class="line"><span class="ruby">--name mysql-master \</span></span><br><span class="line"><span class="ruby">-e TIMEZONE=Asia/Shanghai \</span></span><br><span class="line"><span class="ruby">-v /data/mariadb-<span class="symbol">slave:</span>/data/mariadb \</span></span><br><span class="line"><span class="ruby">-e MYSQL_ROOT_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-e BINLOG_FORMAT=MIXED \</span></span><br><span class="line"><span class="ruby">-e REPLICATION_PASSWORD=admin \</span></span><br><span class="line"><span class="ruby">-e DATABASE_FILE=database.sql \</span></span><br><span class="line"><span class="ruby">-e MASTER_LOG_FILE=mysql-bin.<span class="number">000003</span> \</span></span><br><span class="line"><span class="ruby">-e MASTER_LOG_POS=<span class="number">342</span> \</span></span><br><span class="line"><span class="ruby">-e MASTER_PORT=<span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">-e MASTER_HOST=<span class="number">172.17</span>.<span class="number">0</span>.<span class="number">2</span> \</span></span><br><span class="line"><span class="ruby">-p <span class="number">3308</span><span class="symbol">:</span><span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">mariadb-<span class="symbol">slave:</span><span class="number">1.0</span></span></span><br></pre></td></tr></table></figure>
<p>需要把database.sql文件存提前存放在/data/mariadb-slave目录</p>
<p>进入slaver的mariadb</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span> <span class="selector-tag">-uroot</span> <span class="selector-tag">-padmin</span> <span class="selector-tag">-h</span> 172<span class="selector-class">.17</span><span class="selector-class">.0</span><span class="selector-class">.3</span></span><br></pre></td></tr></table></figure>
<p>设置主库链接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span> master_host=<span class="string">'172.17.0.2'</span>,master_user=<span class="string">'slave'</span>,master_password=<span class="string">'reader'</span>,master_log_file=<span class="string">'mysql-bin.000003'</span>,master_log_pos=<span class="number">342</span>,master_port=<span class="number">3306</span>;</span><br></pre></td></tr></table></figure>
<p>启动从库同步</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>
<p>查看状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G;</span><br></pre></td></tr></table></figure>
<p>当看到</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br></pre></td></tr></table></figure>
<p>则启动成功</p>
<p>##docker redis 集群（cluster）搭建</p>
<p>顺带完成redis集群,安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull redis</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull ruby</span></span><br></pre></td></tr></table></figure>
<p>创建redis容器</p>
<p>1、创建redis配置文件（redis-cluster.tmpl）</p>
<p>我在路径/root下创建一个文件夹redis-cluster,在路径/root/redis-cluster下创建一个文件redis-cluster.tmpl，并把以下内容复制过去。</p>
<p>10.0.2.15 //自己的服务器ip</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port <span class="variable">$&#123;PORT&#125;</span></span><br><span class="line"><span class="keyword">cluster</span>-enabled yes</span><br><span class="line"><span class="keyword">cluster</span>-config-<span class="keyword">file</span> nodes.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">cluster</span>-node-timeout 5000</span><br><span class="line"><span class="keyword">cluster</span>-announce-ip 10.0.2.15</span><br><span class="line"><span class="keyword">cluster</span>-announce-port <span class="variable">$&#123;PORT&#125;</span></span><br><span class="line"><span class="keyword">cluster</span>-announce-bus-port 1<span class="variable">$&#123;PORT&#125;</span></span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>
<p>创建自定义network</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> network </span>create redis-net</span><br></pre></td></tr></table></figure>
<p>在/root/redis-cluster下生成conf和data目标，并生成配置信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> `seq 6379 6384`; <span class="keyword">do</span> \</span><br><span class="line">  mkdir -p ./<span class="variable">$&#123;port&#125;</span>/conf \</span><br><span class="line">  &amp;&amp; <span class="attribute">PORT</span>=<span class="variable">$&#123;port&#125;</span> envsubst &lt; ./redis-cluster.tmpl &gt; ./<span class="variable">$&#123;port&#125;</span>/conf/redis.conf \</span><br><span class="line">  &amp;&amp; mkdir -p ./<span class="variable">$&#123;port&#125;</span>/data; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>创建6个redis容器</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> `seq 6379 6384`; <span class="keyword">do</span> \</span><br><span class="line">  docker <span class="builtin-name">run</span> -d -ti -p <span class="variable">$&#123;port&#125;</span>:<span class="variable">$&#123;port&#125;</span> -p 1<span class="variable">$&#123;port&#125;</span>:1<span class="variable">$&#123;port&#125;</span> \</span><br><span class="line">  -v /root/redis-cluster/<span class="variable">$&#123;port&#125;</span>/conf/redis.conf:/usr/local/etc/redis/redis.conf \</span><br><span class="line">  -v /root/redis-cluster/<span class="variable">$&#123;port&#125;</span>/data:/data \</span><br><span class="line">  --restart always --name redis-<span class="variable">$&#123;port&#125;</span> --net redis-net \</span><br><span class="line">  --sysctl net.core.<span class="attribute">somaxconn</span>=1024 redis redis-server /usr/local/etc/redis/redis.conf; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>通过启动ruby来实现集群</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo yes | docker <span class="keyword">run</span> -i --<span class="keyword">rm</span> --<span class="keyword">net</span> redis-<span class="keyword">net</span> ruby <span class="keyword">sh</span> -c ' \</span><br><span class="line">gem install redis \</span><br><span class="line">&amp;&amp; wget http:<span class="comment">//download.redis.io/redis-stable/src/redis-trib.rb \</span></span><br><span class="line">&amp;&amp; ruby redis-trib.rb create --replicas 1 \</span><br><span class="line">'"$(<span class="keyword">for</span> port <span class="keyword">in</span> `seq 6379 6384`; <span class="keyword">do</span> \</span><br><span class="line">echo -<span class="keyword">n</span> <span class="string">"$(docker inspect --format '&#123;&#123; (index .NetworkSettings.Networks "</span>redis-<span class="keyword">net</span><span class="string">").IPAddress &#125;&#125;' "</span>redis-<span class="variable">$&#123;port&#125;</span><span class="string">")"</span>:<span class="variable">$&#123;port&#125;</span> ' ' ; \</span><br><span class="line">done)"</span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2018/05/24/用容器配置mysql主从实现读写分离/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2017/12/11/去中心化网络游戏设计/"
                            aria-label=": 去中心化网络游戏设计"
                        >
                            去中心化网络游戏设计
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-12-11T17:41:13+08:00">
	
		    12月 11, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/dev/">dev</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>写这篇文章之前,我在想这是属于策划案还是开发框架,最终定位到策划案,希望有更多的游戏设计者能先策划出新的玩法,再来定开发框架.<br>本文所述并未实现过任何代码,也并未用于任何上线产品,纯属概念模型.之所以有这种想法,可能是基于昨晚的一次灵感,以及即将设计的游戏有关.</p>
<h2 id="第一章-去中心化概念"><a href="#第一章-去中心化概念" class="headerlink" title="第一章 去中心化概念"></a>第一章 去中心化概念</h2><p>其实最简单的去中心化游戏就是单机游戏和局域网游戏,但是本文要讲诉的是mmo网络游戏的去中心化,为什么既然网络化了又要去中心化,这不是矛盾吗.<br>网络游戏有个通病,就是网速影响游戏体验过,这是客户端所直接反映的问题,服务端反应的你不能直接感受到的问题,很难做到全球同服,什么意思呢,就是所有玩家不全是在一台服务器上<br>因为服务器是有瓶颈的,本身计算量很大的情况下,socket能承载同时单服1W人在线就很不错了,像coc这种全球一个服的游戏很少,这种服务器的架构就很复杂,绝大部分网游就是分区,另一个好处就是分区重新开始游戏,可以解决通货膨胀问题.coc玩到满级满王满墙也就没有玩下去的动力了.另一方面,单机游戏比起网游,不具备强交互能力,可玩性,游戏性大打折扣.如果做到既能联网交互,又可以不靠网络来获得体验,由客户端去演算游戏逻辑,极大降低服务端成本,这就是本文想探讨的去中心化的游戏.像王者荣耀这样的moba游戏已经很接近本文所说的功能了,但是还是有所区别.至于什么区别读完本文可能有个大致了解.本文要探讨的不是moba,也不是rpg,亦或是slg这些类型,而是总的游戏设计方法.去中心化,没有中心服务器,可以是弱联网,亦或是强联网,核心是有各自客户端或是区域链来演算游戏的逻辑,然而还是有一处中心化得服务器为大家来解决统一数据问题,例如物品交易,这点类似于比特币</p>
<h2 id="第二章-比特币模型"><a href="#第二章-比特币模型" class="headerlink" title="第二章 比特币模型"></a>第二章 比特币模型</h2><p>我大概简单的描述一下比特币,这也是去中心化的基石.比特币是一种符合某种算法结果的数字货币,什么意思呢,比如在某一个坐标区域,坐标值代入md5公式,能得到一个符合”x01”字符串的值,那么就认为你找到一枚数字货币,而且这个货币还能定义下一个坐标区域,也就是说,当前区域总的货币数量是一定的,没有挖掘完之前,也无法开采下一个坐标区域.比特币的函数要比我所述的复杂,但基本上是这个意思,算法是公开的,能得到的货币是有限的,一旦挖掘到货币就与中心服确认,并且获得所有权.那如果把这个模型改造一下.游戏币是从boss掉落的,或者生产制作的.或者任务获得的,假设boss,制作工具,任务都有一个gid,全局唯一ID,而且产生的作者也有个唯一uid,再加上创造出来的时间戳time,那我们可以拿着这些数据,到服务器去鉴别真伪,中心服务器会保存一个私钥,给gid+uid+time+key签名,这个货币就有一个串值,如果同一个uid复制多个货币,因为签名一样,也会被认为是一个货币而删掉其他,如果发生交易,那么这个货币还要一个交易序列,给gid+uid+time+trade+key签名会成为新的串值,而中心服会保存所有货币的最新值,也就是说两个玩家拥有了同样的货币,看他们串值是否是最新的,那么鉴别为旧版货币的就是假币.如果都修改成同一串值,那么看交易序列的最后拥有者是谁,谁就是真币.这是我想到的数字货币模型,但是如果作为游戏币,每一个货币都要保存很多值,所以我更倾向于付费可交易货币做这种去中心化的真伪模型,比如银票.而不能交易的游戏币还是只是简单的数字.</p>
<h2 id="第三章-装备模型"><a href="#第三章-装备模型" class="headerlink" title="第三章 装备模型"></a>第三章 装备模型</h2><p>上述所说比特币模型,数字货币模型,如果直接引用到装备模型,完全可以像数字货币一样,做到去中心化的真伪模型,玩家获得一件装备,属于未鉴定状态,需要向中心服鉴别真伪,如果为伪,那装备没有加成的属性.我们还需要处理的一件事情是防止玩家直接对真实装备改值,这需要第一,配置表的时候就生产一个验证,是否是改过配置表,第二,生成装备的时候要要把属性加入到串码算法中.玩家战斗时检测装备正确性,因为是客户端自己验算,所以也不会对服务端产生压力,目前客户端性能越来越强大,对于简单的演算还是可以接受的.</p>
<h2 id="第四章-函数逻辑模型"><a href="#第四章-函数逻辑模型" class="headerlink" title="第四章 函数逻辑模型"></a>第四章 函数逻辑模型</h2><p>所有的演算,逻辑都在客户端,或者说区域链服,可以把区域链服理解为几个人组局域网后其中一个人为主机的概念,那么客户端也可能对函数进行作弊,这种无法从任何算法上解决,但去中心化还有种思路是,可以认同50%以上的逻辑为正确的逻辑,也就是说假如我5个人联网,有3个人结果一致,就按这3个人的逻辑,如果5个人结果都不一致,那么此次验证失败,那么只要大部分的人保持正确心态,可以容忍少部分人作弊,也只能是自己单机演算作弊,假如多数人作弊的情况下,大环境下也可以认可是公平的.只是作为运营的我们收入大大折扣了,所以要防止这种事情发生.另外,如果防止单机作弊,我的想法是每次函数堆栈(重要的战斗算法)要保存起来参数,返回值,这些,传给服务器做一个校正,是否真伪,如果作弊可以纳入非诚信玩家,并给与一定惩罚</p>
<h2 id="第五章-其他中心化包含的内容"><a href="#第五章-其他中心化包含的内容" class="headerlink" title="第五章 其他中心化包含的内容"></a>第五章 其他中心化包含的内容</h2><p>有些内容是无法去中心化的,比如全局装备鉴别,货币鉴别,装备交易,玩家排行榜,世界聊天,世界地图等这些本身就是要做中心化的交互,所以这里不予讨论,这里只是把战斗,组队,装备掉落这些耗时的主要逻辑在客户端来演算,来增加体验和性能.</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>说了这么多,其实还并没有实现一个基于这个想法的游戏.如果把RPG设计成去中心化,要解决大地图的问题,如果大地图还是中心服那就没有意义,还是需要处理很多逻辑,所以这个适合跑大地图,进副本战斗和回合制战斗的RPG游戏.如果把MOBA设计成去中心化,那其实就是当年的魔兽,星际,只是主机不是一台,而是多台,以大多数人的演算为准,个人感觉,意义也不大,直接做局域网的游戏就可以了,只是加个中心交互,如果用来做SLG,感觉还是不错的,试想一下三国志并不是你一个人在攻城略地,有没有很刺激.如果做其他的小地图副本游戏也是可以的.当然这个设计也是有弊端的,你需要容忍数据不能像ARGP那样及时同步,因为你无法保证组队的5个人每个人的网络都很好,万一有个别人卡住,要么踢掉他,要么等他回来的验算结果.其他的弊端暂未想到,欢迎一起来讨论</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2017/12/11/去中心化网络游戏设计/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Lional. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Lional</h4>
        
            <div id="about-card-bio"><p>Lional</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>游戏开发</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-hwa8dtvl3ezjbw9qczhkptwstcjifni8zzdwth1wphnj5ssrfmxrjcrnzhbv.min.js"></script>
<!--SCRIPTS END-->





    </body>
</html>
